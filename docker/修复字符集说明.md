# Docker 环境下修复 MySQL 字符集问题

## 问题描述
如果数据库中显示的中文变成问号（????），这是因为 MySQL 容器没有正确配置 UTF-8 字符集。

## 解决方案

### 方法 1：使用 Docker Compose 重新创建容器（推荐）

1. **停止并删除现有容器**（如果存在）：
```bash
cd navigation
docker-compose down -v
```

2. **使用新的 docker-compose.yml 启动容器**：
```bash
docker-compose up -d
```

新的配置已经设置了 UTF-8 字符集，容器启动时会自动应用。

### 方法 2：进入 Docker 容器执行 SQL 修复

如果容器已经在运行，可以进入容器执行修复：

1. **进入 MySQL 容器**：
```bash
docker exec -it mysql_navigation bash
```

2. **登录 MySQL**：
```bash
mysql -u root -proot
```

3. **执行修复 SQL**：
```sql
USE navigation;

-- 修改数据库字符集
ALTER DATABASE navigation CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- 修改 categories 表
ALTER TABLE categories CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE categories MODIFY COLUMN title VARCHAR(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE categories MODIFY COLUMN icon VARCHAR(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- 修改 websites 表
ALTER TABLE websites CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE websites MODIFY COLUMN title VARCHAR(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE websites MODIFY COLUMN url VARCHAR(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE websites MODIFY COLUMN description TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE websites MODIFY COLUMN icon VARCHAR(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
```

4. **退出 MySQL 和容器**：
```sql
EXIT;
```
```bash
exit
```

### 方法 3：从外部执行 SQL 脚本

如果已经创建了 `fix_charset.sql` 文件，可以直接从外部执行：

```bash
# 将 SQL 文件复制到容器中
docker cp navigation/backend/fix_charset.sql mysql_navigation:/tmp/fix_charset.sql

# 在容器中执行
docker exec -i mysql_navigation mysql -u root -proot navigation < navigation/backend/fix_charset.sql
```

或者：

```bash
# 直接执行 SQL 命令
docker exec -i mysql_navigation mysql -u root -proot navigation << EOF
ALTER DATABASE navigation CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE categories CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
ALTER TABLE websites CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
EOF
```

## 验证修复

修复后，可以通过以下方式验证：

1. **在容器中查询**：
```bash
docker exec -it mysql_navigation mysql -u root -proot navigation -e "SELECT * FROM categories;"
```

2. **通过 API 查询**：
```bash
curl http://localhost:3001/categories
curl http://localhost:3001/websites
```

3. **重启后端服务**：
```bash
cd navigation/backend
pnpm start:dev
```

## 注意事项

⚠️ **重要提示**：
- 如果数据库中已经有乱码数据（显示为问号），修复字符集后，**已经乱码的数据无法恢复**，需要重新插入正确的数据。
- 修复字符集后，新插入的中文数据会正常显示。
- 如果使用 `docker-compose down -v`，会删除所有数据，请确保已备份重要数据。

## 如果使用现有的 Docker 容器

如果你的 MySQL 容器不是通过 docker-compose 创建的，可以：

1. **查看容器名称**：
```bash
docker ps | grep mysql
```

2. **使用容器名称替换上面的命令中的 `mysql_navigation`**

3. **或者修改 docker-compose.yml 中的服务名称和容器名称以匹配你的现有容器**

