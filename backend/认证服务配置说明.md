# 认证服务配置说明

## 问题描述

如果出现 "认证服务不可用" 的错误，说明 navigation 后端无法连接到 website 认证系统。

## 解决方案

### 方法 1：通过环境变量配置（推荐）

在 `navigation/backend` 目录下创建 `.env` 文件：

```env
# 认证服务 URL
# 如果 website 后端运行在 192.168.10.107:3000，则配置为：
AUTH_SERVICE_URL=http://192.168.10.107:3000/api

# 如果 website 后端运行在 localhost:3000，则配置为：
# AUTH_SERVICE_URL=http://localhost:3000/api
```

### 方法 2：修改代码中的默认值

如果不想使用环境变量，可以直接修改 `navigation/backend/src/auth/auth.service.ts` 文件：

```typescript
// 将 localhost 改为实际的 IP 地址
private readonly authServiceUrl = process.env.AUTH_SERVICE_URL || 'http://192.168.10.107:3000/api';
```

## 如何确定正确的 URL

1. **查看 website 后端运行地址**：
   - 如果 website 后端运行在 `http://192.168.10.107:3000`
   - 则认证服务 URL 应该是 `http://192.168.10.107:3000/api`

2. **检查 website 后端是否正常运行**：
   ```bash
   # 测试认证服务是否可访问
   curl http://192.168.10.107:3000/api/auth/validate
   ```

3. **查看后端日志**：
   - navigation 后端启动时会显示：`🔐 [AuthService] 认证服务 URL: ...`
   - 确认显示的 URL 是否正确

## 验证配置

配置完成后，重启 navigation 后端服务，查看日志：

1. 启动时应该看到：`🔐 [AuthService] 认证服务 URL: http://...`
2. 验证 Token 时应该看到：`🔍 [AuthService] 验证 Token，URL: ...`
3. 如果连接成功，应该看到：`✅ [AuthService] Token 验证成功`
4. 如果连接失败，会看到详细的错误信息

## 常见问题

### 问题 1：ECONNREFUSED 错误
- **原因**：无法连接到认证服务
- **解决**：检查 website 后端是否运行，URL 是否正确

### 问题 2：ETIMEDOUT 错误
- **原因**：连接超时
- **解决**：检查网络连接，确认防火墙设置

### 问题 3：401 Unauthorized
- **原因**：Token 无效或已过期
- **解决**：重新登录获取新的 Token

